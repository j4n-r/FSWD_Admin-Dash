{% extends "base.html" %} {% block title %}chat{% endblock %} {% block head %}
{{ super() }} {% endblock %} {% block content %}
<div class="flex-1 flex-col gap-4 p-4">
  <div class="font-medium text-2xl text-center">{{conv["name"]}}</div>
  <div
    id="chat-window"
    class="flex-1 bg-gray-50 rounded-lg shadow-inner overflow-y-scroll p-4 flex-1 max-h-[500px]"
  >
    {% for msg in messages%} {%if msg.sender_id == user_id%}
    <div class="p-3 bg-[#9798be] w-2/5 rounded-lg ml-auto shadow-sm mb-2" ;>
      <div class="font-bold text-sm mb-1">{{msg.username}}</div>
      {{msg.content}}
    </div>
    {% else %}
    <div class="p-3 bg-white w-2/5 rounded-lg shadow-sm mb-2" ;>
      <div class="font-bold text-sm mb-1">{{msg.username}}</div>
      {{msg.content}}
    </div>
    {%endif%} {%endfor%}
  </div>

  <form id="chat-form" class="flex gap-2">
    <input
      type="text"
      name="chat-input"
      id="chat-input"
      class="flex-1 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:border-blue-500"
      placeholder="Type your message..."
    />
    <button
      type="submit"
      class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
    >
      Send
    </button>
  </form>
</div>

<script>
  const form = document.querySelector("form");
  const chatWindow = document.querySelector("#chat-window");
  const chatInput = document.querySelector("#chat-input");

  function scrollToBottom() {
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const message = formData.get("chat-input");
    if (message.trim()) {
      sendMessage(message);
      chatInput.value = "";
    }
  });

  function connectWs() {
    ws = new WebSocket("ws://0.0.0.0:8080");

    ws.onopen = (event) => {
      console.log("OPEN", event);
      ws.send(
        JSON.stringify({
          messageType: "IdMessage",
          senderId: user.id,
          convId: "{{conv['id']}}",
          timestamp: new Date(),
        }),
      );
    };

    ws.onmessage = (event) => {
      console.log("MESSAGE", event);
      const data = JSON.parse(event.data);
      console.log(data);
      const msg = data.payload.content;
      const userName = data.payload.displayName;

      const msgDiv = document.createElement("div");
      if (data.meta.senderId === user.id) {
        // sender is the same as the currently logged in user
        msgDiv.className =
          "p-3 bg-[#9798be] w-2/5 rounded-lg ml-auto shadow-sm mb-2";
      } else {
        msgDiv.className = "p-3 bg-white w-2/5 rounded-lg shadow-sm mb-2";
      }

      const nameElement = document.createElement("div");
      nameElement.className = "font-bold text-sm mb-1";
      nameElement.textContent = userName;

      const messageContent = document.createElement("div");
      messageContent.textContent = msg;

      msgDiv.appendChild(nameElement);
      msgDiv.appendChild(messageContent);

      chatWindow.append(msgDiv);
      scrollToBottom();
    };

    ws.onerror = (event) => {
      console.error("WebSocket error:", event);
    };

    ws.onclose = (event) => {
      console.log("Websocket closed", event);
      setTimeout(function () {
        connectWs();
      }, 2000);
    };
  }

  function sendMessage(messageText) {
    console.log("{{conv['id']}}");
    const msg = JSON.stringify({
      messageType: "ChatMessage",
      payload: {
        content: messageText,
        displayName: user.name,
      },
      meta: {
        conversationId: "{{conv['id']}}",
        senderId: user.id,
        timestamp: new Date(),
      },
    });
    ws.send(msg);
    console.log("message sent", msg);
    scrollToBottom();
  }
  connectWs();
</script>
{% endblock %}
